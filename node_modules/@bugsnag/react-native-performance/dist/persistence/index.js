import { Platform } from 'react-native';
import { Dirs } from 'react-native-file-access';
import { File, ReadOnlyFile, NullFile } from './file.js';
import FileBasedPersistence from './file-based.js';

const PERSISTENCE_VERSION = 1;
const PERSISTENCE_DIRECTORY = `${Dirs.CacheDir}/bugsnag-performance-react-native/v${PERSISTENCE_VERSION}`;
const PERSISTED_STATE_PATH = `${PERSISTENCE_DIRECTORY}/persisted-state.json`;
function persistenceFactory(fileSystem, deviceInfo) {
    const nativeDeviceIdFilePath = Platform.select({
        get ios() {
            if (deviceInfo && deviceInfo.bundleIdentifier) {
                return `${Dirs.CacheDir}/bugsnag-shared-${deviceInfo.bundleIdentifier}/device-id.json`;
            }
        },
        android: `${Dirs.DocumentDir}/device-id`,
        default: undefined
    });
    const nativeDeviceIdFile = nativeDeviceIdFilePath
        ? new ReadOnlyFile(nativeDeviceIdFilePath, fileSystem)
        : new NullFile();
    return new FileBasedPersistence(new File(PERSISTED_STATE_PATH, fileSystem), nativeDeviceIdFile);
}

export { PERSISTENCE_DIRECTORY, persistenceFactory as default };
